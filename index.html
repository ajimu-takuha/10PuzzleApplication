<!DOCTYPE html>
<html>

<head>
    <title>10PUZZLE(make10Application)</title>
    <meta charset="Shift-jis">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="js/make10.js"></script>
    <!-- <script src="js/index.js"></script> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="area" class="area">
        <div id="particles-js">
        </div>


        <div id="all" v-bind:class="{allOverDrive:mode == 'OverDrive', all:mode != 'OverDrive'}">





            <div v-if="isLoading" class="overlay"></div>
            <div class="contentWrapper">
                <!-- ここにフェードイン・フェードアウトさせたい要素を配置 -->
                <transition name="fade">
                    <div v-if="showCorrect" class="correct-text">
                        {{ correctText }}
                    </div>
                </transition>



                <!-- <template>
                    <div class="container">
                      <div class="row">
                        <div class="mapping-container">
                          <div class="mapping-content" @click="setActiveMapping('first', 0)">
                            <span class="mapping-text">{{ getMappedKey('first', 0) }}</span>
                            <span class="mapping-input" v-if="isActiveMapping('first', 0)">{{ activeMappingText }}</span>
                          </div>
                          <div class="mapping-content" @click="setActiveMapping('first', 1)">
                            <span class="mapping-text">{{ getMappedKey('first', 1) }}</span>
                            <span class="mapping-input" v-if="isActiveMapping('first', 1)">{{ activeMappingText }}</span>
                          </div>
                        </div>
                        <div class="mapping-container">
                          <div class="mapping-content" @click="setActiveMapping('second', 0)">
                            <span class="mapping-text">{{ getMappedKey('second', 0) }}</span>
                            <span class="mapping-input" v-if="isActiveMapping('second', 0)">{{ activeMappingText }}</span>
                          </div>
                          <div class="mapping-content" @click="setActiveMapping('second', 1)">
                            <span class="mapping-text">{{ getMappedKey('second', 1) }}</span>
                            <span class="mapping-input" v-if="isActiveMapping('second', 1)">{{ activeMappingText }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template> -->


                <!-- <div id="correctCube"></div> -->
                <!-- <div id="explanation" class="explanation">
                    <p><span>How to Play this app</span><br>
                        Using the four arithmetic operators and parentheses,<br>
                        create an expression using the numbers<br>
                        generated by pressing the "Start" button, and make sure the answer is 10.<br>
                        In "Use one digit" mode, use numbers from 1 to 9, and in "Use under 20" mode,<br> use numbers
                        from 1 to 19 to create an expression.<br>
                        The "Over Drive" mode is released when you get a certain score in other modes.<br>
                        If you want to practice, press the "Reload" button instead of the "Start" button<br>
                        to generate the number for the mode.<br>
                        If you want to replace the numbers, click on the two numbers you want to replace.<br>
                        If you want to switch between the four arithmetic operators,<br>
                        click where you want to switch.<br>
                        The order in which they are switched is "+, -, ????, ÷".<br>
                        If you want to know the answer to the equation, click the "Show Answer" button,<br> and the
                        challenge will be aborted,<br>
                        but you will be able to see the equation for the answer.<br>
                        You can create an expression that becomes 10 with all the generated numbers.
                    </p>
                    <button id="close" class="close" v-on:click="close()">close</button>
                </div> -->
                <div id="result" class="result" v-if="resultFlag">
                    <br>
                    <div id="scoreWrap">
                        <span id="modeText">　Mode : {{mode}}　</span>
                        <div><br>　Time : {{elapsedTime}}　</div>
                        <div><br>　Reload : {{20 - reloadCount}}　</div>
                        <div><br>　Score : {{score}}　</div>
                    </div>
                    <br><span id="evaluation">{{evaluation}}</span>
                    <span id="evalComment">
                        <br>{{evalComment}}
                    </span>
                    <div id="resultButtonWrapper">
                        <!-- <button id="tryButton" class="resultButton" v-on:click="tryAgain()">Try Again</button> -->
                        <button id="inputUser" class="resultButton" v-on:click="moveRegistScreen()">
                            Registration
                        </button>
                        <button id="checkDetail" class="resultButton" v-on:click="checkDetail()">Details</button>
                    </div>
                    <!-- <button id="closeResult" class="backButton" v-on:click="closeResult()" style="font-size: 40px;">×
                    </button> -->
                    <div class="closeWrapper" v-on:click="closeResult()">
                    </div>
                    <button id="closeResult"></button>
                </div>
                <template v-if="checkDetailFlag">
                    <div id="detailScreen" class="result">
                        <span id="resultDetailTitle">Result Details</span>
                        <div v-for="(detail, index) in answerDetail"
                            v-bind:style="{ backgroundColor: detail.reload == true ? 'rgba(255, 0, 51, 0.6)' : '' }"
                            id="detailWrapper">
                            <div class="solvedNum">
                                {{"Q." + (Number(index) + 1 + "")}}
                            </div>
                            <div class="solvedFormula">
                                {{ (detail.formula).join(" : ").split('').join("") }}
                            </div>
                            <div class="detailAnswerFormula">
                                {{ (detail.answer.replace("return", "").replace(/\*/g, "×").replace(/\//g,
                                "÷")).split('').join(' ') }}
                            </div>
                            <div class="intervalTime">
                                {{ detail.intervalTime + "s"}}
                            </div>
                        </div>
                        <button id="closeDetail" class="backButton" v-on:click="closeDetail()">←
                        </button>
                </template>
                <div v-if="registFlag">
                    <div id="registScreen" class="result">
                        <button id="closeRegist" class="backButton " v-on:click="closeRegist()">←
                        </button>
                        <div id="registTitle" cless="registTitle">Ranking Registration</div>
                        <div style="margin-top: 40px;">　Score : {{score}}　</div>
                        <div>
                            <input type="text" id="registName" name="registName" maxlength="12" required>
                        </div>
                        <div id="warningWrapper">
                            <div id="normalText" style="font-size: 30px" style="font-size: 20px">1〜12 characters can be
                                input
                            </div>
                            <p id="warning" style="display: none">
                                Enter your name !
                            </p>
                        </div>
                        <button id="registButton" class="resultButton" v-on:click="regist()">Registration
                        </button>
                    </div>
                </div>
                <div id="ranking" class="result" v-if="rankingFlag">
                    <div class="itemCovor">
                        <div class="titleAndClose">
                            <div id="rankingTitle" class="rankingTitle">
                                <span style="color: rgb(255, 0, 0)">
                                    {{rankingDisplayMode[modeIndex % rankingDisplayMode.length] }}
                                </span>
                                Ranking
                            </div>
                            <div class="closeWrapper" v-on:click="closeRanking()">
                            </div>
                            <button id="closeRanking" class="closeButton"></button>
                        </div>
                        <div id="rankingItem">
                            <div id="space" class="items">

                            </div>
                            <div id="nameItem" class="items">
                                Name
                            </div>
                            <div id="scoreItem" class="items">
                                Score
                            </div>
                            <div id="dateItem" class="items">
                                Date
                            </div>
                        </div>
                    </div>
                    <div id="rankingContentDigit" class="rankingContent" v-if="showRankingDigit">
                        <div id="rankDetail" class="rankDetail" v-for="(data, index) in rankingDataDigit.data"
                            v-on:click="showUserQuestion(index)">
                            <div id="rankNum" class="rankVal">
                                <span>
                                    {{ index + 1 }}
                                </span>
                            </div>
                            <div id="rankName" class="rankVal">
                                <span>
                                    {{ data[0] }}
                                </span>
                            </div>
                            <div id="rankScore" class="rankVal">
                                <span>
                                    {{ data[1] }}
                                </span>
                            </div>
                            <div id="rankDate" class="rankVal">
                                <span>
                                    {{ data[2] }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div id="rankingContentTeen" class="rankingContent" v-if="showRankingTeen">
                        <div id="rankDetailTeen" class="rankDetail" v-for="(data, index) in rankingDataTeen.data"
                            v-on:click="showUserQuestion(index)">
                            <div id="rankNum" class="rankVal">
                                <span>
                                    {{ index + 1 }}
                                </span>
                            </div>
                            <div id="rankName" class="rankVal">
                                <span>
                                    {{ data[0] }}
                                </span>
                            </div>
                            <div id="rankScore" class="rankVal">
                                <span>
                                    {{ data[1] }}
                                </span>
                            </div>
                            <div id="rankDate" class="rankVal">
                                <span>
                                    {{ data[2] }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div id="rankingContentOD" class="rankingContent" v-if="showRankingOD">
                        <div id="rankDetailOD" class="rankDetail" v-for="(data, index) in rankingDataOD.data"
                            v-on:click="showUserQuestion(index)">
                            <div id="rankNum" class="rankVal">
                                <span>
                                    {{ index + 1 }}
                                </span>
                            </div>
                            <div id="rankName" class="rankVal">
                                <span>
                                    {{ data[0] }}
                                </span>
                            </div>
                            <div id="rankScore" class="rankVal">
                                <span>
                                    {{ data[1] }}
                                </span>
                            </div>
                            <div id="rankDate" class="rankVal">
                                <span>
                                    {{ data[2] }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <button id="rankngModeChange" class="modeChangeButton" v-on:click="rankingModeChange()">Click : {{
                        rankingDisplayMode[(modeIndex + 1) % rankingDisplayMode.length] }}
                    </button>
                </div>
                <div v-if="rankingDetailFlag" class="result">
                    <div id="rankingDetailTitle">User Details</div>
                    <div v-for="(detail, index) in rankingUserDetail"
                        v-bind:style="{ backgroundColor: detail.reload == true ? 'rgba(255, 0, 51, 0.6)' : '' }"
                        id="detailWrapper">
                        <div class="solvedNum">
                            {{"Q." + (Number(index) + 1 + "")}}
                        </div>
                        <div class="solvedFormula">
                            {{ (detail.formula).join(" : ").split('').join("") }}
                        </div>
                        <div class="detailAnswerFormula">
                            {{ (detail.answer.replace("return", "").replace(/\*/g, "×").replace(/\//g,
                            "÷")).split('').join(' ') }}
                        </div>
                        <div class="intervalTime">
                            {{ detail.intervalTime + "s"}}
                        </div>
                    </div>
                    <button id="closeRankingDetail" class="backButton" v-on:click="closeRankingDetail()">←
                    </button>
                </div>
                <div id="answerFormula" class="answerFormula">
                    {{answerFormula}}={{target}}<br>
                    <button id="tryButton" class="tryButton" v-on:click="tryAgain()">Try Again</button>
                </div>
                <div id="answerNoChange" class="answerNoChange" v-if="answerChangeFlag">
                </div>
                <div id="header" v-on:click="showRanking()">
                    <div id="title" v-bind:class="{'overDriveTitle':mode == 'OverDrive', 'title':mode != 'OverDrive'}">
                        {{ title }}
                    </div>
                </div>
                <div id="clearCount"
                    v-bind:class="{'overDriveCount':mode == 'OverDrive', 'clearCount':mode != 'OverDrive'}">
                    Clear:　{{ clearCount }}/10　Reload:　{{ reloadCount }}
                    <p id="targetNum"
                        v-bind:class="{'overDriveCount':mode == 'OverDrive', 'targetNum':mode != 'OverDrive'}">
                        　Target:　{{target}}</p>
                </div>
                <div id="formulaBody">
                    <div id="firstBra" @mouseenter="isHovered0 = true" @mouseleave="isHovered0 = false"
                        v-bind:class="{'hovered0': isHovered0, 'hovered3': isHovered3, 'overDriveBra':mode == 'OverDrive', 'brackets formula':mode != 'OverDrive'}"
                        v-on:click="braChange(0)">
                        {{ brackets[0] }}
                    </div>

                    <div id="addSym"
                        v-bind:class="{'overDriveSym':mode == 'OverDrive', 'symbol formula':mode != 'OverDrive'}"
                        v-on:click="addSymChange">
                        {{ addSym[0] }}
                    </div>

                    <div id="firstN" type="text"
                        v-bind:class="{'overDriveCAct':overDriveNBChange[0], 'clickAct':numBackChange[0], 'overDriveNum':mode == 'OverDrive', 'numbers formula':mode != 'OverDrive'}"
                        v-on:click="numReplace('first')">
                        {{ numbers[0]}}
                    </div>

                    <div id="firstSymbol" class="symbol" :class="{dragging: isDragging && selectedSym === 0 }"
                        @mousedown="startDrag(0, $event)" @mousemove="drag($event)" @mouseup="endDrag"
                        @mouseleave="endDrag" @click="selectSym(0)" ref="draggable0">
                        {{ symValue[0] }}
                    </div>

                    <div id="secondBra" @mouseenter="isHovered1 = true" @mouseleave="isHovered1 = false"
                        v-bind:class="{'hovered1': isHovered1, 'hovered4': isHovered4, 'overDriveBra':mode == 'OverDrive', 'brackets formula':mode != 'OverDrive'}"
                        v-on:click="braChange(1)">
                        {{ brackets[1] }}
                    </div>

                    <div id="secondN" type="math"
                        v-bind:class="{'overDriveCAct':overDriveNBChange[1], 'clickAct':numBackChange[1], 'overDriveNum':mode == 'OverDrive', 'numbers formula':mode != 'OverDrive'}"
                        v-on:click="numReplace('second')">
                        {{ numbers[1] }}
                    </div>

                    <div @mouseenter="isHovered0 = true" @mouseleave="isHovered0 = false"
                        v-bind:class="{'hovered0': isHovered0,  'overDriveBra':mode == 'OverDrive', 'brackets formula':mode != 'OverDrive'}"
                        id="thirdBra" v-on:click="braChange(2)">
                        {{ brackets[2] }}
                    </div>

                    <div id="secondSymbol" class="symbol" :class="{ dragging: isDragging && selectedSym === 1 }"
                        @mousedown="startDrag(1, $event)" @mousemove="drag($event)" @mouseup="endDrag"
                        @mouseleave="endDrag" @click="selectSym(1)" ref="draggable1">
                        {{ symValue[1] }}
                    </div>

                    <div @mouseenter="isHovered2 = true" @mouseleave="isHovered2 = false"
                        v-bind:class="{'hovered2': isHovered2, 'overDriveBra':mode == 'OverDrive', 'brackets formula':mode != 'OverDrive'}"
                        id="forthBra" v-on:click="braChange(3)">
                        {{ brackets[3] }}
                    </div>

                    <div type="math"
                        v-bind:class="{'overDriveCAct':overDriveNBChange[2], 'clickAct':numBackChange[2], 'overDriveNum':mode == 'OverDrive', 'numbers formula':mode != 'OverDrive'}"
                        id="thirdN" v-on:click="numReplace('third')">
                        {{ numbers[2] }}
                    </div>

                    <div @mouseenter="isHovered3 = true" @mouseleave="isHovered3 = false"
                        v-bind:class="{'hovered1': isHovered1,  'hovered3': isHovered3, 'overDriveBra':mode == 'OverDrive', 'brackets formula':mode != 'OverDrive'}"
                        id="fifthBra" v-on:click="braChange(4)">
                        {{ brackets[4] }}
                    </div>

                    <div id="thirdSymbol" class="symbol" :class="{ dragging: isDragging && selectedSym === 2 }"
                        @mousedown="startDrag(2, $event)" @mousemove="drag($event)" @mouseup="endDrag"
                        @mouseleave="endDrag" @click="selectSym(2)" ref="draggable2">
                        {{ symValue[2] }}
                    </div>

                    <div type="math"
                        v-bind:class="{'overDriveCAct':overDriveNBChange[3], 'clickAct':numBackChange[3], 'overDriveNum':mode == 'OverDrive', 'numbers formula':mode != 'OverDrive'}"
                        id="fourthN" v-on:click="numReplace('fourth')">
                        {{ numbers[3] }}
                    </div>

                    <div @mouseenter="isHovered4 = true" @mouseleave="isHovered4 = false"
                        v-bind:class="{'hovered2': isHovered2, 'hovered4': isHovered4, 'overDriveBra':mode == 'OverDrive', 'brackets formula':mode != 'OverDrive'}"
                        id="sixthBra" v-on:click="braChange(5)">
                        {{ brackets[5] }}
                    </div>

                    <div v-bind:class="{'overDriveSym':mode == 'OverDrive', 'ecole':mode != 'OverDrive'}" id="ecole">=
                    </div>

                    <div id="answerWrap">
                        <div class="formula" id="answer"
                            v-bind:class="{'answer': mode != 'OverDrive', 'overDriveAnswer': mode == 'OverDrive'}">
                            {{answer}}
                        </div>
                    </div>
                </div>
                <div id="buttonWrapper">
                    <!-- <button type="button" id="showAnsButton" v-on:click="showAns()"
                        v-bind:class="{'inactive': isStart, 'overDriveButtons overDriveStartButton':mode == 'OverDrive', 'buttons startButton':mode != 'OverDrive'}">Show
                        Answer</button> -->
                    <button type="button" id="startButton" v-on:click="startOrGiveUp()" v-bind:class=" {'overDriveButtons overDriveStartButton':mode=='OverDrive'
                        , 'buttons startButton' :mode !='OverDrive' }"><span v-if="isStart">Give Up</span><span
                            v-else>Start</span></button>
                    <button type="button"
                        v-bind:class="{'overDriveButtons overDriveReloadButton':mode == 'OverDrive', 'buttons reloadButton':mode != 'OverDrive', 'disabledButton': reloadCount == 0 || startFlag !== true || disableButton}"
                        id="reloadButton" v-on:click="reloadClick(); createNum()">Reload</button>
                    <button type="button"
                        v-bind:class="{'overDriveButtons overDriveResetSymButton':mode == 'OverDrive', 'buttons':mode != 'OverDrive', 'disabledButton': startFlag !== true}"
                        id="resetButton" v-on:click="resetSym">Reset</button>
                </div>
                <div id="modeWrapper">
                    <button v-bind:class="{modeButtons: true, digitButton: true, btnIsSelect: btnIsSelect[3]}"
                        v-on:click="modeChangeDigit">Use one digit</button>
                    <button v-bind:class="{modeButtons :true, teensButton: true, btnIsSelect: btnIsSelect[4]}"
                        v-on:click="modeChangeTeens">Use under 20</button>
                    <button id="overDriveButton" v-bind:class="{modeButtons: true, btnIsSelect: btnIsSelect[5]}"
                        v-on:click="modeChangeOverDrive">OverDrive</button>
                </div>
                <div class="controls">
                    <div v-bind:class="{'overDriveTimer':mode == 'OverDrive', 'timer':mode != 'OverDrive'}">{{ time }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- <script src="js/backgroundCSS.js"></script> -->
    <script type="text/javascript" src="js/particles.min.js"></script>
    <script type="text/javascript" src="js/app.js"></script>
    <script src="airtable.js"></script>
</body>
<script>
    "use strict"
    // import axios from "axios";
    const eventBus = new Vue();

    var all = new Vue({
        el: "#all",
        data: {
            title: "Ten Puzzle",
            numbers: ["", "", "", ""],
            passNum: ["first", "second", "third", "fourth", "fifth", "sixth"],
            selectedNum: ["", "", "", "", "", ""],
            numBackChange: [false, false, false, false, false, false],
            overDriveNBChange: [false, false, false, false, false, false],
            selectedNumIndexF: -1,
            selectedNumTF: false,
            bracketNames: [
                "firstBra",
                "secondBra",
                "thirdBra",
                "fourthBra",
                "fifthBra",
                "sixthBra",
            ],
            checkDupNums: [],
            brackets: ["", "", "", "", "", ""],
            selectedBra: ["", "", "", "", "", ""],
            isHovered0: false,
            isHovered1: false,
            isHovered2: false,
            isHovered3: false,
            isHovered4: false,
            isHovered5: false,
            firstSym: ["+"],
            secondSym: ["+"],
            thirdSym: ["+"],
            addSym: ["+"],
            symValue: ["+", "+", "+"],
            clearCount: 0,
            questionCount: 0,
            clearedFormula: [
                [3, 4, 7, 8],
                [1, 1, 5, 8],
            ],
            reloadFormula: [],
            reloadAnswerFormula: [],
            answerDetail: [],
            reloadCount: 20,
            answerFormula: "",
            selectFlag: false,
            startFlag: false,
            ansFlag: false,
            cheatFlag: false,
            clickAct: [false, false, false, false, false, false],
            overDriveCAct: [false, false, false, false, false, false],
            btnIsSelect: [false, false, false, true, false, false],
            mode: "digit",
            target: 10,
            score: 0,
            evaluation: "",
            evalComment: "",
            time: "00:00:000",
            startTime: 0,
            createQuestionTime: 0,
            pausedTimeStart: 0,
            pausedTimeEnd: 0,
            totalPausedTime: 0,
            totalTime: 0,
            elapsedTime: 0,
            isStart: false,
            isStop: true,
            isReset: true,
            isPaused: false,
            timeoutId: 0,
            rankingFlag: false,
            resultFlag: false,
            checkDetailFlag: false,
            registFlag: false,
            answerChangeFlag: false,
            rankingDetailFlag: false,
            rankingData: [],
            rankingUserDetail: [],
            isDragging: false,
            startPosition: { x: 0, y: 0 },
            position: { x: 0, y: 0 },
            lastMousePos: null,
            mouseThreshold: 7,
            selectedSym: null,
            apiKey:
                "patLECZIq2tF3NhKk.e5c426974a99e1e06e1d6e6122d6a76cdb76996c9115fb96316c1471092e11d1",
            baseId: "app1MxnFrdKWBio9q",
            tableName: "name",
            rankingDataDigit: [],
            rankingDataTeen: [],
            rankingDataOD: [],
            showRankingDigit: true,
            showRankingTeen: false,
            showRankingOD: false,
            rankingDisplayMode: ["Digit", "Under20", "OverDrive"],
            modeIndex: 0,
            elements: [
                'firstBra', 'addSym', 'firstN', 'firstSymbol', 'secondBra', 'secondN', 'thirdBra', 'secondSymbol',
                'forthBra', 'thirdN', 'fifthBra', 'thirdSymbol', 'fourthN', 'sixthBra', 'ecole', 'answer'
            ],
            index: 0,
            disableButton: false,
            showCorrect: false, // フェードイン・フェードアウトの表示制御
            correctText: "Correct!", // 表示するテキスト
            isLoading: false,
            actions: {
                first: ['d', 'x'],
                second: ['f', 'y'],
                third: ['j', 'z'],
                fourth: ['k', 'w'],
                fifth: ['s', 't'],
            },
            activeMapping: null,
            activeMappingText: '割り当てるキーを選択',
            activeMapping: null,
            activeMappingText: '割り当てるキーを選択',
        },
        watch: {
            answer: function (ansVal) {
                if (ansVal == this.target && this.startFlag == true) {
                    this.addDetail();
                    this.clearCount++;
                    this.answerDetail[this.questionCount].reload = false;
                    this.questionCount++;
                    if (this.ansFlag == true && ansVal == 1) {
                        this.cheatFlag = true;
                    }
                    this.ansFlag = true;
                    this.selectedNumIndexF = -1;
                    this.selectedNumTF = false;
                    let currentNums = [];
                    for (let i = 0; i < this.numbers.length; i++) {
                        currentNums.push(this.numbers[i]);
                    }
                    this.clearedFormula.splice(this.clearCount, 0, currentNums);
                    if (this.clearCount == 3) {
                        this.elapsedTime = Date.now() - this.startTime - this.totalPausedTime;
                        this.stop();
                        this.startFlag = false;
                        this.resetNumBraSym();
                        this.checkDupNums = [];
                        this.clearedFormula = [];
                        this.ansNoChange();
                        if (this.cheatFlag == true) {
                            this.evaluation = "Cheetah";
                            this.evalComment =
                                "You solved this like a cheetah speed, but don't be a cheater.";
                        } else if (this.score < 700) {
                            this.evaluation = "Slug";
                            if (this.mode == "digit") {
                                this.evalComment = "Try More...";
                            } else if (this.mode == "teen") {
                                this.evalComment = "Try More...";
                            } else {
                                this.evalComment =
                                    "It's just great to be able to clear it without throwing up.";
                            }
                        } else if (700 < this.score && this.score < 750) {
                            this.evaluation = "Hermit Crab";
                            if (this.mode == "digit") {
                                this.evalComment = "Keep it Up!!!";
                            } else if (this.mode == "teen") {
                                this.evalComment = "Keep it Up!";
                            } else {
                                this.evalComment = "You are doing well.";
                            }
                        } else if (750 < this.score && this.score < 850) {
                            this.evaluation = "Gentoo Penguin";
                            if (this.mode == "digit") {
                                this.evalComment = "You were almost there! Come on, man!";
                            } else if (this.mode == "teen") {
                                this.evalComment = "Good luck in the next mode!";
                                document.getElementById("overDriveButton").style.pointerEvents = "auto";
                                document.getElementById("overDriveButton").style.cursor = "pointer";
                                // localStorage.setItem('mode', 'overDrive');
                            } else {
                                this.evalComment = "Very well done. You also need luck.";
                            }
                        } else if (850 < this.score && this.score < 910) {
                            document.getElementById("overDriveButton").style.pointerEvents = "auto";
                            document.getElementById("overDriveButton").style.cursor = "pointer";
                            // localStorage.setItem('mode', 'overDrive');
                            this.evaluation = "Black Mamba";
                            if (this.mode == "digit") {
                                this.evalComment = "Congratu! You are now ready to take on new levels!";
                            } else if (this.mode == "teen") {
                                this.evalComment = "Excellent! You are now ready to take on new levels!";
                            } else {
                                this.evalComment = "You have a great talent. I envy you.";
                            }
                        } else if (910 < this.score && this.score < 940) {
                            document.getElementById("overDriveButton").style.pointerEvents = "auto";
                            document.getElementById("overDriveButton").style.cursor = "pointer";
                            // localStorage.setItem('mode', 'overDrive');
                            this.evaluation = "Springbok";
                            if (this.mode == "digit") {
                                this.evalComment = "Are you Human? You have to play OverDrive mode.";
                            } else if (this.mode == "teen") {
                                this.evalComment = "WTF Great score. Please play in the new mode.";
                            } else {
                                this.evalComment = "You're getting closer to God...";
                            }
                        } else if (940 < this.score) {
                            document.getElementById("overDriveButton").style.pointerEvents = "auto";
                            document.getElementById("overDriveButton").style.cursor = "pointer";
                            // localStorage.setItem('mode', 'overDrive');

                            this.evaluation = "Alian";
                            if (this.mode == "digit") {
                                this.evalComment = "You are Not Human... Welcome OverDrive.";
                            } else if (this.mode == "teen") {
                                this.evalComment = "HOLY... Welcome OverDrive.";
                            } else {
                                this.evalComment =
                                    "OMG I didn't think anyone else would make this score...";
                            }
                        }
                        // const result = document.getElementById("result");
                        this.resultFlag = true;
                    } else {
                        this.isLoading = true;
                        this.pauseTimer();
                        setTimeout(this.createNum, 1500);
                        setTimeout(() => {
                            this.isLoading = false;
                        }, 1500);
                        if (this.clearCount == 9) {
                            this.correctText = "LAST!"
                        } else {
                            this.correctText = "Correct!"
                        }
                        this.startColorChange();

                        // const correctCube = document.getElementById("correctCube");
                        // correctCube.style.display = "block";
                        // setTimeout(() => {
                        //     this.ansFlag = false;
                        // }, 1000);
                        // setTimeout(() => {
                        //     correctCube.style.display = "";
                        // }, 1000);
                        return;
                    }
                }
            },
        },
        computed: {
            answer() {
                let text =
                    "return (" +
                    this.brackets[0] +
                    this.addSym[0] +
                    this.numbers[0] +
                    this.firstSym[0] +
                    this.brackets[1] +
                    this.numbers[1] +
                    this.brackets[2] +
                    this.secondSym[0] +
                    this.brackets[3] +
                    this.numbers[2] +
                    this.brackets[4] +
                    this.thirdSym[0] +
                    this.numbers[3] +
                    this.brackets[5] +
                    ")";
                try {
                    if (text.length >= 16) {
                        return Math.floor(Function(text)() * 10) / 10;
                    }
                } catch (e) {
                    this.resetBra();
                    text =
                        "return (" +
                        this.brackets[0] +
                        this.addSym[0] +
                        this.numbers[0] +
                        this.firstSym[0] +
                        this.brackets[1] +
                        this.numbers[1] +
                        this.brackets[2] +
                        this.secondSym[0] +
                        this.brackets[3] +
                        this.numbers[2] +
                        this.brackets[4] +
                        this.thirdSym[0] +
                        this.numbers[3] +
                        this.brackets[5] +
                        ")";

                    return Math.floor(Function(text)() * 10) / 10;
                }
            },
        },
        mounted() {
            window.addEventListener('keydown', this.handleKeyDown);
            window.addEventListener('keydown', this.handleKeyInput);
            this.eventBus = new Vue();
            eventBus.$on('dataChanged', () => {
                // Airtable APIの初期化
                const Airtable = require('airtable');

                const base = new Airtable({
                    apiKey: 'keyqw2LBx6N2Ijdr2'
                }).base('app1MxnFrdKWBio9q');

                // テーブルの選択
                const table = base('RankingDetail');

                // データの取得と加工
                table.select({
                    filterByFormula: 'mode = "digit"',
                    sort: [{ field: 'score', direction: 'desc' }]
                }).firstPage((err, records) => {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    // 各レコードの要素を配列に格納する
                    const data = records.map(record => {
                        return [record.get('name'), record.get('score'), record.get('date'), record.get('question'), record.get('mode')];
                    });
                    // 連想配列にデータを格納する
                    this.rankingDataDigit = { data: data };
                });

                // データの取得と加工
                table.select({
                    filterByFormula: 'mode = "teen"',
                    sort: [{ field: 'score', direction: 'desc' }]
                }).firstPage((err, records) => {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    // 各レコードの要素を配列に格納する
                    const data = records.map(record => {
                        return [record.get('name'), record.get('score'), record.get('date'), record.get('question'), record.get('mode')];
                    });
                    // 連想配列にデータを格納する
                    this.rankingDataTeen = { data: data };
                });

                // データの取得と加工
                table.select({
                    filterByFormula: 'mode = "OverDrive"',
                    sort: [{ field: 'score', direction: 'desc' }]
                }).firstPage((err, records) => {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    // 各レコードの要素を配列に格納する
                    const data = records.map(record => {
                        return [record.get('name'), record.get('score'), record.get('date'), record.get('question'), record.get('mode')];
                    });
                    // 連想配列にデータを格納する
                    this.rankingDataOD = { data: data };
                });
                // this.getItems();
            });
            this.eventBus = eventBus;
        }, beforeUnmount() {
            window.removeEventListener('keydown', this.handleKeyDown);
        }, beforeDestroy() {
            window.removeEventListener('keydown', this.handleKeyInput);
        },
        // mounted: function () {
        //     if (localStorage.getItem('mode')) {
        //         document.getElementById("overDriveButton").style.pointerEvents = "auto";
        //         document.getElementById("overDriveButton").style.cursor = "pointer";
        //     }
        // },

        methods: {
            setActiveMapping(action) {
                this.activeMapping = action;
                this.activeMappingText = '割り当てるキーを選択';
            },
            saveMappings(event) {
                if (this.activeMapping) {
                    const index = this.activeMapping.indexOf(event.key);
                    if (index !== -1) {
                        this.activeMapping[index] = '';
                    }
                    this.activeMapping[index] = event.key;
                    this.activeMapping = null;
                    this.activeMappingText = '割り当てるキーを選択';
                }
            },
            getMappedKey(action, index) {
                return action[index] ? action[index] : '未割り当て';
            },
            isActiveMapping(action) {
                return this.activeMapping === action;
            },
            handleKeyDown(event) {
                if (this.startFlag) {
                    if (event.key === 'e') {
                        if (this.addSym[0] == "+") {
                            this.addSym.splice(0, 1, "-");
                        } else {
                            this.addSym.splice(0, 1, "+");
                        }
                    } else if (event.key === 'r') {
                        this.symValue[0] = this.getNextSymbol(this.symValue[0]);
                        if (this.symValue[0] == "×") {
                            this.firstSym.splice(0, 1, "*");
                        } else if (this.symValue[0] == "÷") {
                            this.firstSym.splice(0, 1, "/");
                        } else {
                            this.firstSym.splice(0, 1, this.symValue[0]);
                        };
                    } else if (event.key === 'u') {
                        this.symValue[1] = this.getNextSymbol(this.symValue[1]);
                        if (this.symValue[1] == "×") {
                            this.secondSym.splice(0, 1, "*");
                        } else if (this.symValue[1] == "÷") {
                            this.secondSym.splice(0, 1, "/");
                        } else {
                            this.secondSym.splice(0, 1, this.symValue[1]);
                        };
                    } else if (event.key === 'i') {
                        this.symValue[2] = this.getNextSymbol(this.symValue[2]);
                        if (this.symValue[2] == "×") {
                            this.thirdSym.splice(0, 1, "*");
                        } else if (this.symValue[2] == "÷") {
                            this.thirdSym.splice(0, 1, "/");
                        } else {
                            this.thirdSym.splice(0, 1, this.symValue[2]);
                        };
                    } else if (event.key === 'd') {
                        this.numReplace('first');
                    } else if (event.key === 'f') {
                        this.numReplace('second');
                    } else if (event.key === 'j') {
                        this.numReplace('third');
                    } else if (event.key === 'k') {
                        this.numReplace('fourth');
                    } else if (event.key === 's') {
                        this.braChange(0);
                    } else if (event.key === 'g' || event.key === 'h') {
                        this.braChange(1);
                    } else if (event.key === 'l') {
                        this.braChange(3);
                    } else if (event.key === 'a') {
                        this.braChange(4);
                    } else if (event.key === ';') {
                        this.braChange(5);
                    } else if (event.key === 'Escape') {
                        if (!this.disableButton) {
                            this.reloadClick();
                            this.createNum();
                        }
                    } else if (event.key === 'Enter') {
                        if (this.checkDetailFlag) {
                            this.closeDetail();
                        } else {
                            this.startOrGiveUp();
                        }
                    } else if (event.key === 'z') {
                        this.startColorChange();
                    }
                } else if (event.key === 'Enter') {
                    if (this.checkDetailFlag) {
                        this.closeDetail();
                    } else {
                        this.startOrGiveUp();
                    }
                } else if (event.key === 'z') {
                    this.startColorChange();
                }
            },
            correctProcess() {
                this.showCorrect = true; // フェードイン開始
                // 1秒後にフェードインを終了
                setTimeout(() => {
                    this.showCorrect = false; // 要素を非表示にする
                }, 1000);

            },
            getNextSymbol(symbol) {
                const symbols = ["-", "×", "÷", "+"];
                const currentIndex = symbols.indexOf(symbol);
                const nextIndex = (currentIndex + 1) % symbols.length;
                return symbols[nextIndex];
            },
            startDrag(index, event) {
                this.isDragging = true;
                this.startPosition.x = event.clientX;
                this.startPosition.y = event.clientY;
                this.selectedSym = index;
            },
            drag(event) {
                if (this.isDragging) {
                    this.position.x = this.position.x + event.clientX - this.startPosition.x;
                    this.position.y = this.position.y + event.clientY - this.startPosition.y;
                    this.startPosition.x = event.clientX;
                    this.startPosition.y = event.clientY;

                    if (this.lastMousePos) {
                        const deltaX = event.clientX - this.lastMousePos.x;
                        if (Math.abs(deltaX) >= this.mouseThreshold) {
                            if (deltaX > 0) {
                                this.symValue[this.selectedSym] = "-";
                                switch (this.selectedSym) {
                                    case 0:
                                        this.firstSym.splice(0, 1, "-");
                                        break;
                                    case 1:
                                        this.secondSym.splice(0, 1, "-");
                                        break;
                                    case 2:
                                        this.thirdSym.splice(0, 1, "-");
                                        break;
                                }
                            } else {
                                this.symValue[this.selectedSym] = "+";
                                switch (this.selectedSym) {
                                    case 0:
                                        this.firstSym.splice(0, 1, "+");
                                        break;
                                    case 1:
                                        this.secondSym.splice(0, 1, "+");
                                        break;
                                    case 2:
                                        this.thirdSym.splice(0, 1, "+");
                                        break;
                                }
                            }
                            this.lastMousePos.x = event.clientX;
                        }

                        const deltaY = event.clientY - this.lastMousePos.y;
                        if (Math.abs(deltaY) >= this.mouseThreshold) {
                            if (deltaY > 0) {
                                this.symValue[this.selectedSym] = "÷";
                                switch (this.selectedSym) {
                                    case 0:
                                        this.firstSym.splice(0, 1, "/");
                                        break;
                                    case 1:
                                        this.secondSym.splice(0, 1, "/");
                                        break;
                                    case 2:
                                        this.thirdSym.splice(0, 1, "/");
                                        break;
                                }
                            } else {
                                this.symValue[this.selectedSym] = "×";
                                switch (this.selectedSym) {
                                    case 0:
                                        this.firstSym.splice(0, 1, "*");
                                        break;
                                    case 1:
                                        this.secondSym.splice(0, 1, "*");
                                        break;
                                    case 2:
                                        this.thirdSym.splice(0, 1, "*");
                                        break;
                                }
                            }
                            this.lastMousePos.y = event.clientY;
                        }
                    } else {
                        this.lastMousePos = { x: event.clientX, y: event.clientY };
                    }
                }
            },
            endDrag() {
                this.isDragging = false;
                this.lastMousePos = null;
            },
            selectSym(index) {
                this.selectedSym = index;
            },
            modeChangeDigit() {
                this.mode = "digit";
                this.title = "Ten Puzzle";
                this.btnIsSelect.splice(3, 1, true);
                this.btnIsSelect.splice(4, 1, false);
                this.btnIsSelect.splice(5, 1, false);
                this.tryAgain();
                this.target = 10;
            },
            modeChangeTeens() {
                this.mode = "teen";
                this.title = "Ten Puzzle";
                this.btnIsSelect.splice(3, 1, false);
                this.btnIsSelect.splice(4, 1, true);
                this.btnIsSelect.splice(5, 1, false);
                this.tryAgain();
                this.target = 10;

            },
            modeChangeOverDrive() {
                this.mode = "OverDrive";
                this.title = "Number Puzzle";
                this.btnIsSelect.splice(3, 1, false);
                this.btnIsSelect.splice(4, 1, false);
                this.btnIsSelect.splice(5, 1, true);
                this.tryAgain();
            },
            //startボタン押下時、もしくはanswer==10の時に数値をランダ??に変更
            matchCreateNum(nums) {
                if (this.checkEasyAnswer(nums, this.target)) {
                    return false;
                }

                // 配列を小さい順に並べ替える
                nums.sort((a, b) => a - b);
                // 過去の問題と重複が無いか確かめる
                for (let i = 0; i < this.checkDupNums.length; i++) {
                    if (this.areArraysEqual(nums, this.checkDupNums[i])) {
                        return false;
                    }
                }

                return true;

            }, checkEasyAnswer(nums, target) {
                if (nums[0] + nums[1] + nums[2] + nums[3] == target ||
                    // 引き算チェック
                    - nums[0] + nums[1] + nums[2] + nums[3] == target ||
                    nums[0] - nums[1] + nums[2] + nums[3] == target ||
                    nums[0] + nums[1] - nums[2] + nums[3] == target ||
                    nums[0] + nums[1] + nums[2] - nums[3] == target ||
                    // 引き算2箇所チェック
                    - nums[0] - nums[1] + nums[2] + nums[3] == target ||
                    - nums[0] + nums[1] - nums[2] + nums[3] == target ||
                    - nums[0] + nums[1] + nums[2] - nums[3] == target ||
                    nums[0] - nums[1] - nums[2] + nums[3] == target ||
                    nums[0] - nums[1] + nums[2] - nums[3] == target ||
                    nums[0] + nums[1] - nums[2] - nums[3] == target ||
                    // 掛け算チェック
                    nums[0] * nums[1] + nums[2] + nums[3] == target ||
                    nums[0] * nums[2] + nums[1] + nums[3] == target ||
                    nums[0] * nums[3] + nums[2] + nums[1] == target ||
                    nums[0] + nums[1] * nums[2] + nums[3] == target ||
                    nums[0] + nums[1] * nums[3] + nums[2] == target ||
                    nums[0] + nums[1] + nums[2] * nums[3] == target ||
                    // 割り算チェック（番号--小÷大）
                    nums[0] / nums[1] + nums[2] + nums[3] == target ||
                    nums[0] / nums[2] + nums[1] + nums[3] == target ||
                    nums[0] / nums[3] + nums[2] + nums[1] == target ||
                    nums[0] + nums[1] / nums[2] + nums[3] == target ||
                    nums[0] + nums[1] / nums[3] + nums[2] == target ||
                    nums[0] + nums[1] + nums[2] / nums[3] == target ||
                    // 割り算チェック（番号--大÷小）
                    nums[1] / nums[0] + nums[2] + nums[3] == target ||
                    nums[2] / nums[0] + nums[1] + nums[3] == target ||
                    nums[3] / nums[0] + nums[2] + nums[1] == target ||
                    nums[0] + nums[2] / nums[1] + nums[3] == target ||
                    nums[0] + nums[3] / nums[1] + nums[2] == target ||
                    nums[0] + nums[1] + nums[3] / nums[2] == target) {
                    // console.log(nums + "check失敗");
                    return false;
                };
            },

            createNum() {
                if (this.isPaused == false) {
                    this.pauseTimer();
                }

                if (this.mode == "digit") {
                    let nums = [];
                    do {
                        for (let i = 0; i < 4; i++) {
                            nums[i] = Math.floor(Math.random() * 9) + 1;
                        }
                    }
                    while (!this.matchCreateNum(nums));

                    let [TrueOrFalse, make10Ans] = make10(nums, 10);
                    if (TrueOrFalse) {
                        for (let i = 0; i < this.numbers.length; i++) {
                            this.numbers.splice(i, 1, nums[i]);
                        }
                        this.answerFormula = make10Ans;

                        // 重複が無かったので追加
                        this.checkDupNums.push(nums);
                    } else {
                        this.createNum();
                        return;
                    }
                } else if (this.mode == "teen") {
                    let nums = [];
                    do {
                        for (let i = 0; i < 4; i++) {
                            nums[i] = Math.floor(Math.random() * 19) + 1;
                        }
                    }
                    while (!nums.some(num => num >= 10) || !this.matchCreateNum(nums));

                    let [TrueOrFalse, make10Ans] = make10(nums, 10);
                    if (TrueOrFalse) {
                        for (let i = 0; i < this.numbers.length; i++) {
                            this.numbers.splice(i, 1, nums[i]);
                        }
                        this.answerFormula = make10Ans;

                        // 重複が無かったので追加
                        this.checkDupNums.push(nums);
                    } else {
                        this.createNum();
                        return;
                    }

                } else if (this.mode == "OverDrive") {
                    let nums = [];
                    do {
                        for (let i = 0; i < this.numbers.length; i++) {
                            nums[i] = Math.floor(Math.random() * 40 + 1) / 2;
                        }
                    }
                    while (!this.matchCreateNum(nums));

                    let [TrueOrFalse, make10Ans] = make10(nums, 10);
                    if (TrueOrFalse) {
                        for (let i = 0; i < this.numbers.length; i++) {
                            this.numbers.splice(i, 1, nums[i]);
                        }
                        this.answerFormula = make10Ans;

                        // 重複が無かったので追加
                        this.checkDupNums.push(nums);
                    } else {
                        this.createNum();
                        return;
                    }
                }
                this.selectFlag = false;
                this.selectedNumTF = false;
                for (let i = 0; i < this.numBackChange.length; i++) {
                    this.numBackChange.splice(i, 1, false);
                    this.overDriveNBChange.splice(i, 1, false);
                }
                for (let i = 0; i < this.selectedNum.length; i++) {
                    this.selectedNum.splice(i, 1, "");
                }
                this.firstSym.splice(0, 1, "+");
                this.secondSym.splice(0, 1, "+");
                this.thirdSym.splice(0, 1, "+");
                this.addSym.splice(0, 1, "+");
                for (let i = 0; i < this.symValue.length; i++) {
                    this.symValue.splice(i, 1, "+");
                }
                this.resetBra();
                this.resumeTimer();
                this.createQuestionTime = Date.now();

            },
            areArraysEqual(array1, array2) {
                const sortedArray1 = array1.slice().sort();
                const sortedArray2 = array2.slice().sort();
                for (let i = 0; i < sortedArray1.length; i++) {
                    if (sortedArray1[i] !== sortedArray2[i]) {
                        return false;
                    }
                }
                return true;
            },
            // 記号1か所変更のみで正解する場合は抽選をやり直す
            // ansCheck(make10Ans) {
            //     let plusCount = (make10Ans.match(/\+/g) || []).length;
            //     let minusCount = (make10Ans.match(/\-/g) || []).length;
            //     if (
            //         (plusCount >= 2 && make10Ans.indexOf("(") == -1) ||
            //         (plusCount == 1 && minusCount == 2)
            //     ) {
            //         // this.createNum();
            //         return false;
            //     }
            //     return true;
            // },
            changeBackgroundColor(element) {
                let opacity = 0;
                const targetOpacity = 0.5;
                const transitionDuration = 200; // 背景色の変化にかける時間（ミリ秒）
                const revertDuration = 100; // 元に戻す時間（ミリ秒）

                const originalBackgroundColor = element.style.backgroundColor; // 元の背景色を保持する

                const startTimeProcess = performance.now();

                const changeTimer = setInterval(() => {
                    const elapsedTime = performance.now() - startTimeProcess;
                    const progress = elapsedTime / transitionDuration;

                    opacity = progress * targetOpacity; // オパシティを徐々に増加させる
                    element.style.backgroundColor = `rgba(255, 255, 255, ${opacity})`;

                    if (progress >= 1) {
                        clearInterval(changeTimer); // 背景色の変化タイマーを停止する

                        // 元に戻すタイマーを開始する
                        const revertTimer = setInterval(() => {
                            const elapsedTime = performance.now() - (startTimeProcess + transitionDuration);
                            const progress = elapsedTime / revertDuration;

                            opacity = targetOpacity - progress * targetOpacity; // オパシティを徐々に減少させる
                            element.style.backgroundColor = `rgba(255, 255, 255, ${opacity})`;

                            if (progress >= 1) {
                                clearInterval(revertTimer); // 元に戻すタイマーを停止する
                                element.style.backgroundColor = originalBackgroundColor; // 元の背景色に戻す
                            }
                        }, 10);
                    }
                }, 10);
            },
            changeNextElementColor(index) {
                if (index < this.elements.length) {
                    const elementId = this.elements[index];
                    const element = document.getElementById(elementId);
                    this.changeBackgroundColor(element);
                    setTimeout(() => {
                        this.changeNextElementColor(index + 1);
                    }, 40);
                } else {
                    // 全ての要素の背景色変更が完了した後に correctProcess を呼び出す
                    this.correctProcess();
                }
            },
            startColorChange() {
                this.changeNextElementColor(0);
            },
            addDetail() {
                let data_tmp = {};
                data_tmp.intervalTime = this.questionThinkTime();
                let currentNums = [];
                for (let i = 0; i < this.numbers.length; i++) {
                    currentNums.push(this.numbers[i]);
                }
                data_tmp.formula = currentNums;
                data_tmp.answer = this.answerFormula;
                data_tmp.reload = "";
                this.answerDetail.push(data_tmp);
            },
            braChange(braNumber) {
                if (this.selectedBra[braNumber] == "") {
                    if (braNumber == 0) {
                        this.brackets.splice(0, 1, "(");
                        this.brackets.splice(2, 1, ")");
                        this.selectedBra[0] = true;
                        this.selectedBra[2] = true;
                    } else if (braNumber == 1) {
                        this.brackets.splice(1, 1, "(");
                        this.brackets.splice(4, 1, ")");
                        this.selectedBra[1] = true;
                        this.selectedBra[4] = true;
                    } else if (braNumber == 2) {
                        this.brackets.splice(0, 1, "(");
                        this.brackets.splice(2, 1, ")");
                        this.selectedBra[0] = true;
                        this.selectedBra[2] = true;
                    } else if (braNumber == 3) {
                        this.brackets.splice(3, 1, "(");
                        this.brackets.splice(5, 1, ")");
                        this.selectedBra[3] = true;
                        this.selectedBra[5] = true;
                    } else if (braNumber == 4) {
                        this.brackets.splice(0, 1, "(");
                        this.brackets.splice(4, 1, ")");
                        this.selectedBra[0] = true;
                        this.selectedBra[4] = true;
                    } else {
                        this.brackets.splice(1, 1, "(");
                        this.brackets.splice(5, 1, ")");
                        this.selectedBra[1] = true;
                        this.selectedBra[5] = true;
                    }

                    // for (let i = 0; i < this.bracketNames.length; i++) {
                    //     if (this.bracketNames[i] == braNumber) {
                    //         if (this.brackets[i] == "(" || this.brackets[i] == ")") {
                    //             this.resetBra();
                    //             return;
                    //         }
                    //         if (this.mode != "OverDrive") {
                    //             this.clickAct.splice(i, 1, true);
                    //         } else {
                    //             this.overDriveCAct.splice(i, 1, true);
                    //         }
                    //         this.selectedBra.splice(i, 1, "replace");
                    //     }
                    // }
                    // this.selectFlag = true;
                } else {
                    this.resetBra();
                }
                //二番目に選択した括弧????????selectedBraに反映し、Bracktsと差し替えて画面に反映
                // else if (this.selectFlag == true) {
                //     for (let i = 0; i < this.bracketNames.length; i++) {
                //         if (this.bracketNames[i] == braNumber) {
                //             this.selectedBra.splice(i, 1, "replace");
                //         }
                //         this.clickAct.splice(i, 1, false);
                //         this.overDriveCAct.splice(i, 1, false);
                //     }
                //     if (this.selectedBra.indexOf("replace") == this.selectedBra.lastIndexOf("replace")) {
                //         this.resetBra();
                //         this.selectFlag = false;
                //     } else {
                //         this.selectedBra.splice(this.selectedBra.indexOf("replace"), 1, "(");
                //         this.selectedBra.splice(this.selectedBra.lastIndexOf("replace"), 1, ")");
                //         this.brackets.splice(0, this.brackets.length);
                //         this.brackets.push(...this.selectedBra);
                //         this.selectFlag = false;
                //     }
                // }
            },
            // 全ての括弧を削除し、clickActクラス?????てfalseに
            resetBra() {
                for (let i = 0; i < this.brackets.length; i++) {
                    this.selectedBra.splice(i, 1, "");
                    this.brackets.splice(i, 1, "");
                    this.clickAct.splice(i, 1, false);
                    this.overDriveCAct.splice(i, 1, false);
                }
            },
            resetSym() {
                this.firstSym.splice(0, 1, "+");
                this.secondSym.splice(0, 1, "+");
                this.thirdSym.splice(0, 1, "+");
                this.addSym.splice(0, 1, "+");
                for (let i = 0; i < this.symValue.length; i++) {
                    this.symValue.splice(i, 1, "+");
                }
            },
            //選択した数字同士の場所を置換する
            numReplace(received) {
                if (this.selectedNumTF == false) {
                    for (let i = 0; i < this.numbers.length; i++) {
                        if (this.passNum[i] == received) {
                            this.selectedNum[i] = this.numbers[i];
                            if (this.mode != "OverDrive") {
                                this.numBackChange.splice(i, 1, true);
                            } else {
                                this.overDriveNBChange.splice(i, 1, true);
                            }
                            // 始めに選択した数値の番号をselectedNumIndexFに代入
                            this.selectedNumIndexF = i;
                        }
                    }
                    this.selectedNumTF = true;
                    // 選択された数値と位置はselectedNumに格納される
                } else if (this.selectedNumTF == true) {
                    for (let i = 0; i < this.numbers.length; i++) {
                        if (this.passNum[i] == received) {
                            this.selectedNum[i] = this.numbers[i];
                            // 始めに選択した数値をfirstValueに格??
                            let firstValue = this.selectedNum[this.selectedNumIndexF];
                            // 始めに選択した数値を後に選択した数値に置き換??
                            this.numbers.splice(this.selectedNumIndexF, 1, this.selectedNum[i]);
                            // 後に選択した数値(番号 = i)を始めに選択した数値に置き換??
                            this.numbers.splice(i, 1, firstValue);
                        }
                    }
                    for (let i = 0; i < this.selectedNum.length; i++) {
                        this.selectedNum.splice(i, 1, "");
                    }
                    for (let i = 0; i < this.numBackChange.length; i++) {
                        this.numBackChange.splice(i, 1, false);
                        this.overDriveNBChange.splice(i, 1, false);
                    }
                    this.selectedNumIndexF = -1;
                    this.selectedNumTF = false;
                }
            },
            addSymChange() {
                if (all.addSym[0] == "+") {
                    Vue.set(all.addSym, 0, "-");
                    this.symValue.splice(3, 1, "-");
                } else if (all.addSym[0] == "-") {
                    Vue.set(all.addSym, 0, "+");
                    this.symValue.splice(3, 1, "+");
                }
            },
            reloadClick() {

                this.addDetail();
                this.answerDetail[this.questionCount].reload = true;
                if (this.reloadCount > 0) {
                    this.reloadCount--;
                }
                this.questionCount++;
                let repNums = this.numbers.concat();
                this.reloadFormula.push(repNums);
                this.reloadAnswerFormula.push(this.answerFormula);
                // ボタンを無効化する
                // this.disableButton = true;

                // 一定時間後にボタンを有効化する
                // setTimeout(() => {
                //     this.disableButton = false;
                // }, 1000);
            },
            tryAgain() {
                this.btnIsSelect.splice(0, 1, false);
                this.resultFlag = false;
                // answerFormula.style.display = "";
                this.clearCount = 0;
                // this.createCount = 0;
                this.reloadCount = 20;
                this.startFlag = false;
                this.ansFlag = false;
                this.cheatFlag = false;
                // this.clearedFormula = [];
                this.stop();
                this.reset();
                this.resetBra();
                this.resetNumBraSym();
                this.ansChange();
            },
            startOrGiveUp() {
                if (this.isStart == true) {

                    let currentNums = [];
                    for (let i = 0; i < this.numbers.length; i++) {
                        currentNums.push(this.numbers[i]);
                    }
                    let data_tmp = {};
                    data_tmp.formula = currentNums;
                    data_tmp.answer = this.answerFormula;

                    let solvedTime = Date.now();
                    let intervalTime = solvedTime - this.createQuestionTime;
                    // this.createQuestionTime = solvedTime;
                    intervalTime = (Math.round(intervalTime / 100) / 10).toFixed(1);
                    data_tmp.intervalTime = intervalTime;

                    data_tmp.reload = "";
                    this.answerDetail.push(data_tmp);
                    this.answerDetail[this.questionCount].reload = true;
                    this.checkDetailFlag = true;
                    this.firstSym.splice(0, 1, "+");
                    this.secondSym.splice(0, 1, "+");
                    this.thirdSym.splice(0, 1, "+");
                    this.addSym.splice(0, 1, "+");
                    for (let i = 0; i < this.symValue.length; i++) {
                        this.symValue.splice(i, 1, "+");
                    }
                    for (let i = 0; i < this.numbers.length; i++) {
                        this.numbers.splice(i, 1, "");
                    }
                    for (let i = 0; i < 3; i++) {
                        this.btnIsSelect[i] = false;
                    }

                    this.startFlag = false;
                    this.isStart = false;
                    this.isStop = true;
                    this.isReset = false;
                    this.stop();
                    this.time = "00:00:000";
                    clearTimeout(this.timeoutId);
                    this.isStop = true;
                    this.isReset = true;
                    this.score = 0;
                    this.elapsedTime = 0;
                    this.totalTime = 0;
                    this.checkDupNums = [];

                    this.selectedNumIndexF = -1;
                    this.selectedNumTF = false;
                    this.clearedFormula = [];
                    this.isStart = false;
                } else {
                    this.start();
                    this.createNum();
                }
            },
            close() {
                this.ansChange();
            },
            rankingClose() {
                const ranking = document.getElementById("ranking");
                ranking.style.display = "none";
            },
            resetNumBraSym() {
                this.resetBra();
                this.firstSym.splice(0, 1, "+");
                this.secondSym.splice(0, 1, "+");
                this.thirdSym.splice(0, 1, "+");
                this.addSym.splice(0, 1, "+");
                for (let i = 0; i < this.symValue.length; i++) {
                    this.symValue.splice(i, 1, "+");
                }
                for (let i = 0; i < this.numbers.length; i++) {
                    this.numbers.splice(i, 1, "");
                }
                for (let i = 0; i < 3; i++) {
                    this.btnIsSelect[i] = false;
                }
                this.selectedNumIndexF = -1;
                this.selectedNumTF = false;
            },
            closeResult() {
                this.resultFlag = false;
                this.tryAgain();
            },
            checkDetail() {
                this.checkDetailFlag = true;
            },
            closeDetail() {
                this.checkDetailFlag = false;
                this.registFlag = false;
            },
            closeRankingDetail() {
                this.rankingDetailFlag = false;
            },
            moveRegistScreen() {
                this.registFlag = true;
            },
            closeRegist() {
                this.checkDetailFlag = false;
                this.registFlag = false;
            },
            closeRanking() {
                this.rankingFlag = false;
            },
            regist() {
                // Airtableのクライアントライブラリ使用
                var Airtable = require('airtable');
                var base = new Airtable({ apiKey: 'keyqw2LBx6N2Ijdr2' }).base('app1MxnFrdKWBio9q');

                // 入力された名前
                let userName = document.getElementById("registName").value;
                if (userName == "") {
                    document.getElementById("warning").style.display = "block";
                    document.getElementById("normalText").style.display = "none";
                    return;
                } else {
                    // 入力内容
                    const date = new Date(); // 現在時刻
                    const year = date.getFullYear().toString().slice(-2);
                    const month = ("0" + (date.getMonth() + 1)).slice(-2);
                    const day = ("0" + date.getDate()).slice(-2);
                    const nowStr = `${year}/${month}/${day}`;

                    // プレイヤーのスコア
                    let strScore = this.score.toString();

                    // プレイヤーのmode
                    let strMode = this.mode.toString();

                    // プレイヤーの解いた問題
                    const answerDetailString = JSON.stringify(this.answerDetail);

                    // データをAirtableに保存
                    var data = {
                        name: userName,
                        score: strScore,
                        date: nowStr,
                        question: answerDetailString,
                        mode: strMode,
                    };
                    base('RankingDetail').create(data, function (err, record) {
                        if (err) {
                            console.error(err);
                            return;
                        }
                    });

                    // score順にソート
                    const table = base('RankingDetail');

                    table.select({
                        view: 'Grid view',
                        sort: [{ field: 'score', direction: 'desc' }]
                    }).firstPage(function (err, records) {
                        if (err) { console.error(err); return; }
                        records.forEach(function (record) {
                            console.log('Score:', record.get('score'));
                        });
                    });

                    // 101列目以降のデータを取得する
                    const query = { fields: [], maxRecords: 100, view: 'Grid view' };
                    for (let i = 101; i <= 200; i++) {
                        query.fields.push(`Column ${i}`);
                    }
                    // テーブルの全データを取得
                    const records = [];
                    base('RankingDetail').select(query).eachPage(function page(records, fetchNextPage) {
                        // 取得したレコードを配列に追加
                        records.forEach(record => {
                            records.push(record);
                        });
                        fetchNextPage();
                    }, function done(err) {
                        if (err) {
                            console.error(err);
                            return;
                        }
                        // 取得したレコードを削除
                        records.forEach(record => {
                            record.destroy((err, deletedRecord) => {
                                if (err) {
                                    console.error(err);
                                    return;
                                }
                                console.log('Deleted record:', deletedRecord.id);
                            });
                        });
                    });
                }
                this.registFlag = false;
                this.resultFlag = false;
            },
            showRanking() {
                this.eventBus.$emit('dataChanged'); // データを初期化するために dataChanged イベントを発生させる
                this.rankingFlag = true;
                // this.getItems();
            },
            showUserQuestion(index) {
                this.rankingDetailFlag = true;
                let userDetailTmp = [];
                switch (this.rankingDisplayMode[this.modeIndex]) {
                    case "Digit":
                        userDetailTmp = this.rankingDataDigit.data[index];
                        this.rankingUserDetail = JSON.parse(userDetailTmp[3]);
                        eventBus.$emit('dataChanged');
                        break;
                    case "Under20":
                        userDetailTmp = this.rankingDataTeen.data[index];
                        this.rankingUserDetail = JSON.parse(userDetailTmp[3]);
                        eventBus.$emit('dataChanged');
                        break;
                    case "OverDrive":
                        userDetailTmp = this.rankingDataOD.data[index];
                        this.rankingUserDetail = JSON.parse(userDetailTmp[3]);
                        eventBus.$emit('dataChanged');
                        break;
                }
                // userDetailTmp = this.rankingDataDigit.data[index];
                // console.log(userDetailTmp);
                // this.rankingUserDetail = JSON.parse(userDetailTmp[3]);
                // console.log(this.rankingUserDetail);
                // eventBus.$emit('dataChanged');
            },
            rankingModeChange() {
                switch (this.rankingDisplayMode[this.modeIndex]) {
                    case "Digit":
                        this.modeIndex = (this.modeIndex + 1) % this.rankingDisplayMode.length;
                        this.showRankingOD = false;
                        this.showRankingDigit = false;
                        this.showRankingTeen = true;
                        break;
                    case "Under20":
                        this.modeIndex = (this.modeIndex + 1) % this.rankingDisplayMode.length;
                        this.showRankingDigit = false;
                        this.showRankingTeen = false;
                        this.showRankingOD = true;
                        break;
                    case "OverDrive":
                        this.modeIndex = (this.modeIndex + 1) % this.rankingDisplayMode.length;
                        this.showRankingOD = false;
                        this.showRankingTeen = false;
                        this.showRankingDigit = true;
                        break;
                }
            },
            getItems() {
                const storage = window.localStorage;
                let rankingData = Object.entries(storage)
                    .sort(([key1], [key2]) => key2 - key1)
                    .map(([key, value]) => ({ key, value: JSON.parse(value) }));
                this.rankingData = rankingData;
                let rankingDisplayData = this.rankingData.key;
            },
            ansChange() {
                this.answerChangeFlag = false;
            },
            ansNoChange() {
                this.answerChangeFlag = true;
            },
            // ネットから
            countUp() {
                if (this.isPaused) {
                    return; // タイマーが一時停止中は処理を中断
                }

                const elapsedTime = Date.now() - this.totalPausedTime;
                const d = new Date(elapsedTime - this.startTime);
                const m = String(d.getMinutes()).padStart(2, "0");
                const s = String(d.getSeconds()).padStart(2, "0");
                const ms = String(d.getMilliseconds()).padStart(3, "0");

                this.time = `${m}:${s}:${ms}`;
                this.timeoutId = setTimeout(() => {
                    this.countUp();
                }, 10);

            }, pauseTimer() {
                clearTimeout(this.timeoutId);
                this.isPaused = true;
                this.pausedTimeStart = Date.now()
            },
            resumeTimer() {
                if (this.startTime == 0) {
                    this.startTime = Date.now();
                } else {
                    this.pausedTimeEnd = Date.now();
                    this.totalPausedTime += this.pausedTimeEnd - this.pausedTimeStart
                    // console.log("総停止時間は" + this.totalPausedTime)
                }
                this.isPaused = false;
                this.countUp();
            },
            setButtonStateInitial() {
                this.isStart = false;
                this.isStop = true;
                this.isReset = true;
            },
            setButtonStateRunning() {
                this.isStart = true;
                this.isStop = false;
                this.isReset = true;
            },
            setButtonStateStopped() {
                this.isStart = false;
                this.isStop = true;
                this.isReset = false;
            },
            start() {
                this.clearCount = 0;
                this.btnIsSelect.splice(0, 1, true);
                this.reloadCount = 20;
                this.questionCount = 0;
                this.startFlag = true;
                this.ansFlag = false;
                this.cheatFlag = false;
                this.clearedFormula = [];
                this.reloadFormula = [];
                this.reloadAnswerFormula = [];
                this.answerDetail = [];
                this.setButtonStateRunning();
                this.startTime = 0;
                this.totalPausedTime = 0;
                this.pausedTimeEnd = 0;
                this.pausedTimeStart = 0;
                this.isPaused = false;
                this.createQuestionTime = Date.now();
            },
            stop() {
                if (this.isStop) {
                    return;
                }
                this.setButtonStateStopped();
                clearTimeout(this.timeoutId);
                this.elapsedTime = Math.round((this.elapsedTime) / 100) / 10;

                console.log(this.elapsedTime);

                this.score = 1000 - (this.elapsedTime + 10 * (20 - (this.reloadCount)));
            },
            questionThinkTime() {
                let solvedTime = Date.now();
                let intervalTime = solvedTime - this.createQuestionTime;
                intervalTime = (Math.round(intervalTime / 100) / 10).toFixed(1);
                return intervalTime;
            },
            reset() {
                if (this.isReset) {
                    return;
                }
                this.time = "00:00:000";
                this.setButtonStateInitial();
                this.elapsedTime = 0;
            },
        },
    });
</script>

</html>